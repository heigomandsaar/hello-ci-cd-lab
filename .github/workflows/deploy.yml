name: CI/CD (self-hosted, advanced)

on:
  push:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install
        
      - name: Debug rendered page content
        run: |
          sed -n '1,200p' views/pages/index.ejs        
        
      - name: Run tests
        run: npm test
        
        
  deploy:
    needs: test  
    runs-on: self-hosted
  
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set variables
        run: |
          echo "IMAGE_TAG=${GITHUB_SHA}" >> $GITHUB_ENV
          echo "APP_ENV=dev" >> $GITHUB_ENV

      - name: Save current image (for rollback)
        run: |
          docker inspect hello --format='{{.Image}}' > previous_image.txt || echo "none" > previous_image.txt

      - name: Build Docker image
        run: |
          docker build \
            -t nodejs-app:latest \
            -t nodejs-app:${IMAGE_TAG} .

      - name: Deploy with docker-compose
        run: |
          docker compose down || true
          IMAGE_TAG=${IMAGE_TAG} APP_ENV=${APP_ENV} docker compose up -d

      - name: Health check
        run: |
          echo "Waiting for app..."
          sleep 5
          curl -f http://localhost:3000

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, rolling back..."
          PREV_IMAGE=$(cat previous_image.txt)

          if [ "$PREV_IMAGE" != "none" ]; then
            docker stop hello || true
            docker rm hello || true
            docker run -d -p 3000:3000 --name hello $PREV_IMAGE
          else
            echo "No previous image to roll back to"
          fi